<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Stellarium remote control plugin</title>
  <link type="text/css" rel="stylesheet" href="/external/jquery-ui.css"/>
  <link type="text/css" rel="stylesheet" href="style.css" />
  <script src="/external/jquery-1.11.3.js" type="text/javascript"></script>
  <script src="/external/jquery-ui.js" type="text/javascript"></script>
  <script src="time.js" type="text/javascript"></script>
  <script src="remotecontrol.js" type="text/javascript"></script>
  <script type="text/javascript">
  //<![CDATA[
    "use strict";
    //here the buttons get hooked up
    $(function(){
      var runscriptfn = function(){
        var selection = $("#scriptlist").children("option").filter(":selected").text();
        if(selection)
        {
          //post a run requests
          Main.postCmd("/api/scripts/run", {id: selection});
        }
      };
      
      $("#scriptlist").dblclick(runscriptfn);
      $("#bt_runscript").click(runscriptfn);
      
      var runactionfn = function() {
        var $selection = $("#actionlist").find("option").filter(":selected");
        var id = $selection.data("id");
        
        Actions.execute(id);
      }
      
      $("#actionlist").dblclick(runactionfn);
      $("#bt_doaction").click(runactionfn);
      
      $("#bt_stopscript").click(function(){
        //post a stop request
        Main.postCmd("/api/scripts/stop");
      });
      $("#bt_timerewind").click(Time.decreaseTimeRate);
      $("#bt_timeforward").click(Time.increaseTimeRate);
      $("#bt_timeplaypause").click(Time.togglePlayPause);
      $("#bt_timenow").click(Time.setDateNow);
    
      //jQuery UI initialization
      $("#timewidget").tabs();
      $( document ).tooltip();
      $("#spinner").spinner();
      
      $("#date_year").spinner({ 
        min: -100000,
        max: 100000
      }).data({type: "date", field: "year"});
      $("#date_month").spinner({ 
        min: 0,
        max: 13
      }).data({type: "date", field: "month"});
      $("#date_day").spinner({ 
        min: 0,
        max: 32
      }).data({type: "date", field: "day"});
      $("#time_hour").spinner({
        min: -1,
        max: 24
      }).data({type: "time", field: "hour"});
      $("#time_minute").spinner({
        min: -1,
        max: 60
      }).data({type: "time", field: "minute"});
      $("#time_second").spinner({
        min: -1,
        max: 60
      }).data({type: "time", field: "second"});
      $("#input_jd").spinner({
        min: -100000000,
        max: 100000000,
        numberFormat: "d5",
        step: 0.00001
      });
      $("#input_mjd").spinner({
        min: -100000000,
        max: 100000000,
        numberFormat: "d5",
        step: 0.00001
      });
      
      //use delegated event style here to reduce number of unique events
      var scope =".timedisplay input";
      $("#timewidget").on("focusin", scope, function(evt){
        Time.enterTimeEditMode();
      }).on("focusout", scope, function(evt){
        Time.leaveTimeEditMode();
      });
      
      $("#time_local").on('input',scope, function () {
        if($(this).data('onInputPrevented')) return;
        var val = this.value,  $this = $(this),  max = $this.spinner('option', 'max'),  min = $this.spinner('option', 'min');
        console.log("val: " + val);
        if (!val.match(/^\d+$/)) val = $this.data('prevData'); //we want only number, no alpha
        val = parseFloat(val);
        this.value = val > max ? max : val < min ? min : val;
        //for some obscure reason, this.value may be a string instead of a float, so use val directly!
        if(val !== $this.data('prevData')) Time.setDateTimeField($(this).data("type"),$(this).data("field"),val);
      }).on('keydown',scope, function (e) { // to allow 'Backspace' key behaviour
        $(this).data('onInputPrevented', e.which === 8 ? true : false);
        $(this).data('prevData',this.value);
      }).on("spin",scope, function(evt,ui) {
        Time.setDateTimeField($(this).data("type"),$(this).data("field"),ui.value);
        return false;
      });
      
      $("#input_jd").on('input', function () {
        if($(this).data('onInputPrevented')) return;
        var val = this.value,  $this = $(this),  max = $this.spinner('option', 'max'), min = $this.spinner('option', 'min');
        console.log("val: " + val);
        if (!val.match(/^\d+\.?\d*$/)) val = $this.data('prevData'); //we want only number, no alpha
        var val2 = parseFloat(val);
        this.value = val2 > max ? max : val2 < min ? min : val2;
        //for some obscure reason, this.value may be a string instead of a float, so use val directly!
        if(val !== $this.data('prevData')) Time.setJDay(val2);
      }).on('keydown', function (e) { // to allow 'Backspace' key behaviour
        $(this).data('onInputPrevented', e.which === 8 ? true : false);
        $(this).data('prevData',this.value);
      }).on("spin", function(evt,ui) {
        Time.setJDay(ui.value);
      });
      
      $("#input_mjd").on('input', function () {
        if($(this).data('onInputPrevented')) return;
        var val = this.value,  $this = $(this),  max = $this.spinner('option', 'max'), min = $this.spinner('option', 'min');
        console.log("val: " + val);
        if (!val.match(/^\d+\.?\d*$/)) val = $this.data('prevData'); //we want only number, no alpha
        var val2 = parseFloat(val);
        this.value = val2 > max ? max : val2 < min ? min : val2;
        //for some obscure reason, this.value may be a string instead of a float, so use val directly!
        if(val !== $this.data('prevData')) Time.setJDay(val2 + 2400000.5);
      }).on('keydown', function (e) { // to allow 'Backspace' key behaviour
        $(this).data('onInputPrevented', e.which === 8 ? true : false);
        $(this).data('prevData',this.value);
      }).on("spin", function(evt,ui) {
        Time.setJDay(ui.value + 2400000.5);
      });

      var $loading = $("#loadindicator").hide(), timer;
      $(document).ajaxStart(function(){
        timer && clearTimeout(timer);
        timer = setTimeout(function(){
          $loading.show();
        },100)        
      });
      $(document).ajaxStop(function(){
        clearTimeout(timer);
        $loading.hide();
      });
    });
  //]]>
  </script>
</head>
<body>
  <div id="wrapper" class="ui-corner-all ui-widget-content">
    <header>
      <img src="stellarium.png" alt="Stellarium logo"/>
      <h1>Stellarium remote control</h1>
    </header>
    <section id="main" class="block">
      <header><h2>Main stuff</h2></header>
    <div id="timewidget">
    <ul>
      <li><a href="#time_local">Local Time</a></li>
      <li><a href="#time_jday">Julian Date</a></li>
    </ul>
    <div id="time_local" class="timetab">
      <p class="timedisplay">
        <input id="date_year" />
        /
        <input id="date_month" />
        /
        <input id="date_day" />
      </p>
      <p class="timedisplay">
        <input id="time_hour" />
        :
        <input id="time_minute" />
        :
        <input id="time_second" />
      </p>
    </div>
    <div id="time_jday" class="timetab">
      <div>
        <p class="timedisplay">JD: <input id="input_jd"/></p>
        <p class="timedisplay">MJD: <input id="input_mjd"/></p>
      </div>
    </div>
    </div>
    <p>&Delta;T = <span id="deltat"></span></p>
    <ul id="timecontrols" class="ui-corner-all ui-widget-content">
      <!-- TODO move all buttons into single image -->
      <li id="bt_timerewind" class="button32" title="Decrease time speed"></li><li id="bt_timeplaypause" class="button32" title="Pause"></li><li id="bt_timenow" class="button32" title="Set time to now"></li><li id="bt_timeforward" class="button32" title="Increase time speed"></li>
    </ul>
    </section>
    <section id="scripts" class="block">
      <header><h2>Scripts</h2></header>
      <select id="scriptlist" class="scrollselect" size="10">
      </select>
      <div>Active script: <span id="activescript">-none-</span></div>
      <div><button id="bt_runscript" disabled>Run selected script</button><button id="bt_stopscript" disabled>Stop current script</button></div>
    </section>
    <section id="stelaction" class="block">
      <header><h2>Actions</h2></header>
      <select id="actionlist" class="scrollselect" size="10">
      </select>
      <div>
        <button id="bt_doaction" disabled>Run/toggle action</button>
      </div>
    </section>
  </div>
  <div id="footer">
    <div id="loadindicator"></div><div id="noresponse" class="ui-state-error">No response from server since <span id="noresponsetime">0</span> seconds. Is Stellarium still running?</div>
  </div>
</body>
</html>
